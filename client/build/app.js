!function(){"use strict";function t(t,n,e,i){return new(e||(e=Promise))(function(s,o){function r(t){try{l(i.next(t))}catch(t){o(t)}}function u(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){t.done?s(t.value):new e(function(n){n(t.value)}).then(r,u)}l((i=i.apply(t,n)).next())})}function n(t){let n,e,i=t.length;for(;i>0;)e=Math.floor(Math.random()*i),i-=1,n=t[i],t[i]=t[e],t[e]=n;return t}function e(){const t=document.getElementById("play-button"),n=document.getElementById("skip-button"),e=document.getElementById("caption"),i=new l(Array.from(document.getElementsByClassName("cover"))),s=new o("/api"),r=new u(s);s.refresh(),r.onplay=(()=>{const n=r.playing||r.paused;n?(e.textContent=`${n.artist} - ${n.title}`,s.getAlbumBySong(n.id).then(t=>{return t.getCover(s)}).then(t=>{i.switch(t)})):(i.switch(null),e.textContent=""),r.playing?t.className="fa fa-pause playing":t.className="fa fa-play"}),t.addEventListener("click",function(){r.playing?r.togglePause():r.paused?r.togglePause():r.shuffle()}),n.addEventListener("click",function(){r.skip()});const c=document.getElementById("albums-button"),a=document.getElementById("album-list"),f=new h(a,s);f.setPlayer(r),c.addEventListener("click",function(){f.toggle()})}class i{constructor(t,n,e,i,s,o){this.id=t,this.title=n,this.albumArtist=e,this.year=i,this.tracks=s,this.haveCover=o,this.cover=null,this.thumbnail=null}getCover(t){return this.haveCover?this.cover?new Promise((t,n)=>{t(this.cover)}):self.fetch(`${t.root}/music/album/${this.id}/cover`).then(t=>{return t.ok?t.blob():null}).then(t=>{return this.cover=t,t}):new Promise((t,n)=>{t(null)})}getThumbnail(t){return this.haveCover?this.thumbnail?new Promise((t,n)=>{t(this.thumbnail)}):self.fetch(`${t.root}/music/album/${this.id}/thumbnail`).then(t=>{return t.ok?t.blob():null}).then(t=>{return this.thumbnail=t,t}):new Promise((t,n)=>{t(null)})}compare(t){const n=this.albumArtist.toLowerCase().split(/^"|the\W/i).join(""),e=t.albumArtist.toLowerCase().split(/^"|the\W/i).join("");return n>e?1:n<e?-1:this.year>t.year?1:this.year<t.year?-1:0}static parse(t){return new i(t.id,t.title,t.album_artist,t.year,t.tracks,t.cover)}}class s{constructor(t,n,e){this.id=t,this.title=n,this.artist=e}stream(){return`/music/song/${this.id}/stream`}static parse(t){return new s(t.id,t.title,t.artist)}}class o{constructor(t){this.root=t,this.songs=[],this.albums=[],this.songCache=new Map,this.albumCache=new Map,this.albumIndex=new Map}refresh(){const t=[],n=new Set,e=new Map;return self.fetch(`${this.root}/music/songs`).then(t=>{return t.json()}).then(i=>{for(let o of i){t.push(o.id),n.add(o.album),this.albumIndex.set(o.id,o.album);try{e.set(o.id,s.parse(o))}catch(t){console.error(`Error parsing song ${o.id}`),console.error(t)}}this.songs=t,this.albums=Array.from(n.keys()),this.songCache=e}).catch(t=>{console.error("Invalid response from server",t)})}shuffle(){return this.refresh().then(()=>{return n(this.songs),this.songs})}songUrl(t){return this.root+t.stream()}getSong(t){return this.songCache.has(t)?this.songCache.get(t):null}getAlbums(){return t(this,void 0,Promise,function*(){const t=[],n=yield self.fetch(`${this.root}/music/albums`),e=yield n.json();for(let s=0;s<e.length;s+=1){const n=i.parse(e[s]);this.albumCache.set(n.id,n),t.push(n)}return t})}getAlbum(t){return this.albumCache.has(t)?new Promise((n,e)=>{n(this.albumCache.get(t))}):self.fetch(`${this.root}/music/album/${t}/metadata`).then(t=>{return t.json()}).then(n=>{const e=i.parse(n);return this.albumCache.set(t,e),e})}getAlbumBySong(t){return this.getAlbum(this.albumIndex.get(t))}}const r="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP";class u{constructor(t){this.playing=null,this.paused=null,this.library=t,this.playlist=[],this.onplay=(()=>{}),this._initElement()}play(t){this.playlist=t.reverse(),this.doPlay()}togglePause(){return this.paused?(this.element.play(),this.playing=this.paused,this.paused=null,void this.onplay()):(this.element.pause(),this.paused=this.playing,this.playing=null,void this.onplay())}skip(){this.doPlay()}shuffle(){this.library.shuffle().then(t=>t.map(t=>{return this.library.getSong(t)})).then(t=>{this.play(t)})}doPlay(){if(this.paused=null,this.playing=null,0===this.playlist.length)return this.onplay(),void(this.element.error||this.element.pause());const t=this.playlist.pop();this.playing=t,this.element.src=this.library.songUrl(t),this.element.play(),this.onplay()}_initElement(){this.element=document.createElement("audio"),this.element.controls=!1,this.element.onended=(()=>{this.doPlay()}),this.element.onerror=(()=>{const t=this.playing?this.playing.id:"unknown";console.error(`Error playing ${t}`),this.doPlay()})}}class l{constructor(t){this.elements=t.slice(0,2),this.curCover=null,this.cur=0}switch(t){if(t!==this.curCover)return this.curCover=t,this.currentElement.classList.add("old"),this.cur=(this.cur+1)%2,this.currentElement.classList.remove("old"),null===t?void(this.currentElement.src=r):void(this.currentElement.src=URL.createObjectURL(t))}get currentElement(){return this.elements[this.cur]}}class h{constructor(t,n){this.root=t,this.shown=!1,this.library=n,this.onPlay=(()=>{}),this.onShuffle=(()=>{})}setPlayer(t){this.onPlay=(n=>{t.play(n)}),this.onShuffle=(()=>{t.shuffle()})}hide(){this.root.innerHTML="",this.shown=!1}toggle(){return this.shown?void this.hide():(this.shown=!0,void this.library.getAlbums().then(t=>{t.sort((t,n)=>{return t.compare(n)}),this.root.innerHTML="";{const t=document.createElement("div");t.addEventListener("click",()=>{this.onShuffle()});const n=document.createElement("span");n.className="fa fa-random",n.title="Shuffle",t.appendChild(n),this.root.appendChild(t)}for(let n of t){const t=document.createElement("div"),e=n;t.addEventListener("click",()=>{const t=e.tracks.map(t=>{return this.library.getSong(t)});this.onPlay(t),this.hide()}),e.getThumbnail(this.library).then(n=>{if(null!==n)t.innerHTML="",t.style.backgroundImage=`url(${URL.createObjectURL(n)})`,t.style.backgroundColor="transparent";else{const n=document.createElement("div"),i=document.createElement("div");n.textContent=e.albumArtist,i.textContent=e.title,t.appendChild(n),t.appendChild(i),t.style.backgroundImage=""}}),this.root.appendChild(t)}}))}}window.addEventListener("DOMContentLoaded",function(){e()})}();