!function(){"use strict";function t(t,e=0){return t[3+e]<<0|t[2+e]<<8|t[1+e]<<16|t[0+e]<<24}function e(t){let e,n,i=t.length;for(;i>0;)n=Math.floor(Math.random()*i),e=t[i-=1],t[i]=t[n],t[n]=e;return t}function n(){}function i(t){for(var e,n,i=1,s=arguments.length;i<s;i++){n=arguments[i];for(e in n)t[e]=n[e]}return t}function s(t,e){e.appendChild(t)}function o(t,e,n){e.insertBefore(t,n)}function r(t){t.parentNode.removeChild(t)}function a(t,e,n){for(var i=n;i<t.length;i+=1)t[i]&&t[i].destroy(e)}function l(t){return document.createElement(t)}function u(t){return document.createTextNode(t)}function c(){return document.createComment("")}function h(t,e,n){t.addEventListener(e,n,!1)}function m(t,e,n){t.removeEventListener(e,n,!1)}function d(t,e,n){t.setAttribute(e,n)}function f(t){this.destroy=n,this.fire("destroy"),this.set=this.get=n,!1!==t&&this._fragment.unmount(),this._fragment.destroy(),this._fragment=this._state=null}function p(t,e){return t!==e||t&&"object"==typeof t||"function"==typeof t}function g(t,e,n,i,s){for(var o in e)if(n[o]){var r=i[o],a=s[o],l=e[o];if(l)for(var u=0;u<l.length;u+=1){var c=l[u];c.__calling||(c.__calling=!0,c.call(t,r,a),c.__calling=!1)}}}function y(t){for(;t&&t.length;)t.pop()()}function b(t){d(t,"svelte-3994211942","")}function v(){var t=l("style");t.id="svelte-3994211942-style",t.textContent="[svelte-3994211942].album-list,[svelte-3994211942] .album-list{display:flex;flex-wrap:wrap;position:absolute;top:50px}[svelte-3994211942].album-list > div,[svelte-3994211942] .album-list > div{background-color:#444;color:white;font-size:80%;font-family:sans-serif;width:100px;height:100px;background-size:cover;margin-left:2px;margin-right:2px;cursor:pointer;position:relative;transition:all 0.25s;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;-moz-user-select:none;-webkit-user-select:none}[svelte-3994211942].album-list > div > div,[svelte-3994211942] .album-list > div > div{padding-top:5px;padding-bottom:5px;pointer-events:none}[svelte-3994211942].album-list > div:active,[svelte-3994211942] .album-list > div:active{top:-6px}[svelte-3994211942].album-list > div:first-child,[svelte-3994211942] .album-list > div:first-child{font-size:100%;background-color:transparent}",s(t,document.head)}function _(t,e){var n,i=t.show&&C(t,e);return{create:function(){i&&i.create(),n=c()},mount:function(t,e){i&&i.mount(t,e),o(n,t,e)},update:function(t,s){s.show?i?i.update(t,s):((i=C(s,e)).create(),i.mount(n.parentNode,n)):i&&(i.unmount(),i.destroy(),i=null)},unmount:function(){i&&i.unmount(),r(n)},destroy:function(){i&&i.destroy()}}}function w(t,e,n,i,s){var a,u=x(t,e,n,i),c=u(t,e,n,i,s);return{create:function(){a=l("div"),c.create(),this.hydrate()},hydrate:function(t){h(a,"click",E),a._svelte={component:s,each_block_value:e,album_index:i}},mount:function(t,e){o(a,t,e),c.mount(a,null)},update:function(t,e,n,i,o){a._svelte.each_block_value=n,a._svelte.album_index=o,u===(u=x(e,n,i,o))&&c?c.update(t,e,n,i,o):(c.unmount(),c.destroy(),(c=u(e,n,i,o,s)).create(),c.mount(a,null))},unmount:function(){r(a),c.unmount()},destroy:function(){m(a,"click",E),c.destroy()}}}function k(t,e,i,s,a){var u,c,h;return{create:function(){u=l("img"),this.hydrate()},hydrate:function(e){u.width="100",u.height="100",u.src=c=t.library.thumbnails.get(i.id),u.alt=h=i.albumArtist+" - "+i.title},mount:function(t,e){o(u,t,e)},update:function(t,e,n,i,s){t.library&&c!==(c=e.library.thumbnails.get(i.id))&&(u.src=c),t.library&&h!==(h=i.albumArtist+" - "+i.title)&&(u.alt=h)},unmount:function(){r(u)},destroy:n}}function A(t,e,i,a,c){var h,m,d,f,p,g=i.albumArtist,y=i.title;return{create:function(){h=l("div"),m=u(g),d=u("\n        "),f=l("div"),p=u(y)},mount:function(t,e){o(h,t,e),s(m,h),o(d,t,e),o(f,t,e),s(p,f)},update:function(t,e,n,i,s){t.library&&g!==(g=i.albumArtist)&&(m.data=g),t.library&&y!==(y=i.title)&&(p.data=y)},unmount:function(){r(h),r(d),r(f)},destroy:n}}function C(t,e){function n(t){e.fire("shuffle")}for(var i,c,d,f,p=t.library.albums,g=[],y=0;y<p.length;y+=1)g[y]=w(t,p,p[y],y,e);return{create:function(){i=l("div"),c=l("div"),d=l("span"),f=u("\n\n    ");for(var t=0;t<g.length;t+=1)g[t].create();this.hydrate()},hydrate:function(t){b(i),i.className="album-list",h(c,"click",n),d.className="fa fa-random",d.title="Shuffle"},mount:function(t,e){o(i,t,e),s(c,i),s(d,c),s(f,i);for(var n=0;n<g.length;n+=1)g[n].mount(i,null)},update:function(t,n){var s=n.library.albums;if(t.library){for(var o=0;o<s.length;o+=1)g[o]?g[o].update(t,n,s,s[o],o):(g[o]=w(n,s,s[o],o,e),g[o].create(),g[o].mount(i,null));for(;o<g.length;o+=1)g[o].unmount(),g[o].destroy();g.length=s.length}},unmount:function(){r(i);for(var t=0;t<g.length;t+=1)g[t].unmount()},destroy:function(){m(c,"click",n),a(g,!1,0)}}}function E(t){var e=this._svelte.component,n=this._svelte.each_block_value[this._svelte.album_index];e.fire("select",n)}function x(t,e,n,i){return t.library.thumbnails.has(n.id)?k:A}function L(t){this.options=t,this._state=i(U.data(),t.data),this._observers={pre:Object.create(null),post:Object.create(null)},this._handlers=Object.create(null),this._root=t._root||this,this._yield=t._yield,this._bind=t._bind,document.getElementById("svelte-3994211942-style")||v(),this._fragment=_(this._state,this),t.target&&(this._fragment.create(),this._fragment.mount(t.target,t.anchor||null))}function P(){const t=document.getElementById("back-button"),e=document.getElementById("play-button"),n=document.getElementById("skip-button"),i=document.getElementById("caption"),s=new N(Array.from(document.getElementsByClassName("cover"))),o=new $("/api"),r=new O(o);r.onplay=(()=>{const t=r.playing||r.paused;t?(i.textContent=`${t.artist} - ${t.title}`,o.getAlbumBySong(t.id).then(t=>{s.switch(o.getCover(t))})):(s.switch(null),i.textContent=""),r.playing?e.className="fa fa-pause playing":e.className="fa fa-play"}),t.addEventListener("click",function(){r.back()}),e.addEventListener("click",function(){r.playing?r.togglePause():r.paused?r.togglePause():r.shuffle()}),n.addEventListener("click",function(){r.skip()});const a=document.getElementById("albums-button"),l=new L({target:document.getElementById("album-list"),data:{library:o}});l.on("shuffle",()=>{r.shuffle(),l.set({show:!1})}),l.on("select",t=>{const e=t.tracks.map(t=>o.getSong(t));r.play(e),l.set({show:!1})}),a.addEventListener("click",function(){l.set({show:!l.get("show")})}),o.onUpdate=(()=>l.set({library:o})),o.refresh()}class j{constructor(t,e,n,i,s){this.id=t,this.title=e,this.albumArtist=n,this.year=i,this.tracks=s,this.thumbnail=null,this.haveCover=!0}compare(t){const e=this.albumArtist.toLowerCase().split(/^"|the\W/i).join(""),n=t.albumArtist.toLowerCase().split(/^"|the\W/i).join("");return e>n?1:e<n?-1:this.year>t.year?1:this.year<t.year?-1:0}static parse(t){return new j(t.id,t.title,t.album_artist,t.year,t.tracks)}}class B{constructor(t,e,n){this.id=t,this.title=e,this.artist=n}stream(){return`/music/song/${this.id}/stream`}static parse(t){return new B(t.id,t.title,t.artist)}}class ${constructor(t){this.root=t,this.songs=[],this.albums=[],this.thumbnails=new Map,this.songCache=new Map,this.albumCache=new Map,this.albumIndex=new Map,this.onUpdate=(()=>{})}async refresh(){const t=[],e=new Map,n=new Map;try{const i=await self.fetch(`${this.root}/music/songs`),s=await i.json();for(const i of s.songs){t.push(i.id),n.set(i.id,i.album_id);try{e.set(i.id,B.parse(i))}catch(t){console.error(`Error parsing song ${i.id}`),console.error(t)}}}catch(t){return void console.error("Error getting song manifest",t)}this.songs=t,this.songCache=e,this.albumIndex=n,this.albums=await this.getAlbums(),await this.getThumbnails(),this.onUpdate()}async shuffle(){return e(this.songs),this.songs}songUrl(t){return this.root+t.stream()}getSong(t){return this.songCache.has(t)?this.songCache.get(t):null}getCover(t){return`${this.root}/music/album/${t.id}/cover`}async getThumbnails(){const e=Array.from(this.albums),n=e.map(t=>encodeURIComponent(t.id)).join(","),i=await fetch(`${this.root}/music/thumbnail?ids=${n}`),s=await i.arrayBuffer(),o=new Uint8Array(s);let r=0;const a=[];for(;r<o.length;){const e=t(o,r);if(r+=4,0===e){a.push(null);continue}const n=new Blob([o.slice(r,e+r)],{type:"image/jpeg"});r+=e;const i=URL.createObjectURL(n);a.push(i)}for(const t of this.thumbnails.keys())URL.revokeObjectURL(this.thumbnails.get(t));this.thumbnails.clear();for(let t=0;t<a.length;t+=1)null!==a[t]&&this.thumbnails.set(e[t].id,a[t])}async getAlbums(){const t=await self.fetch(`${this.root}/music/albums`),e=await t.json(),n=[];for(const t of e.albums){const e=j.parse(t);this.albumCache.set(e.id,e),n.push(e)}return n.sort((t,e)=>t.compare(e))}async getAlbum(t){if(this.albumCache.has(t))return this.albumCache.get(t);const e=await self.fetch(`${this.root}/music/album/${t}/metadata`),n=await e.json(),i=j.parse(n);return this.albumCache.set(t,i),i}getAlbumBySong(t){return this.getAlbum(this.albumIndex.get(t))}}var I={destroy:f,get:function(t){return t?this._state[t]:this._state},fire:function(t,e){var n=t in this._handlers&&this._handlers[t].slice();if(n)for(var i=0;i<n.length;i+=1)n[i].call(this,e)},observe:function(t,e,n){var i=n&&n.defer?this._observers.post:this._observers.pre;return(i[t]||(i[t]=[])).push(e),n&&!1===n.init||(e.__calling=!0,e.call(this,this._state[t]),e.__calling=!1),{cancel:function(){var n=i[t].indexOf(e);~n&&i[t].splice(n,1)}}},on:function(t,e){if("teardown"===t)return this.on("destroy",e);var n=this._handlers[t]||(this._handlers[t]=[]);return n.push(e),{cancel:function(){var t=n.indexOf(e);~t&&n.splice(t,1)}}},set:function(t){this._set(i({},t)),this._root._lock||(this._root._lock=!0,y(this._root._beforecreate),y(this._root._oncreate),y(this._root._aftercreate),this._root._lock=!1)},teardown:f,_recompute:n,_set:function(t){var e=this._state,n={},s=!1;for(var o in t)p(t[o],e[o])&&(n[o]=s=!0);s&&(this._state=i({},e,t),this._recompute(n,this._state,e,!1),this._bind&&this._bind(n,this._state),g(this,this._observers.pre,n,this._state,e),this._fragment.update(n,this._state),g(this,this._observers.post,n,this._state,e))},_mount:function(t,e){this._fragment.mount(t,e)},_unmount:function(){this._fragment.unmount()}},U={data:()=>({show:!1})};i(L.prototype,I);const M="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP";class O{constructor(t){this.playing=null,this.paused=null,this.library=t,this.playlist=[],this.playlistPosition=0,this.onplay=(()=>{}),this._initElement()}play(t){this.playlist=t,this.doPlay(0)}togglePause(){if(this.paused)return this.element.play(),this.playing=this.paused,this.paused=null,void this.onplay();this.element.pause(),this.paused=this.playing,this.playing=null,this.onplay()}skip(){this.doPlay(1)}back(){this.element&&(this.element.currentTime>=4||0===this.playlistPosition?this.element.currentTime=0:this.doPlay(-1))}shuffle(){this.library.shuffle().then(t=>t.map(t=>this.library.getSong(t))).then(t=>{this.play(t)})}doPlay(t){if(this.paused=null,this.playing=null,this.playlistPosition>=this.playlist.length)return this.onplay(),void(this.element.error||this.element.pause());this.playlistPosition+=t;const e=this.playlist[this.playlistPosition];this.playing=e,this.element.src=this.library.songUrl(e),this.element.play(),this.onplay()}_initElement(){this.element=document.createElement("audio"),this.element.controls=!1,this.element.onended=(()=>{this.doPlay(1)}),this.element.onerror=(()=>{const t=this.playing?this.playing.id:"unknown";console.error(`Error playing ${t}`),this.doPlay(1)})}}class N{constructor(t){this.elements=t.slice(0,2),this.curCover=null,this.cur=0}switch(t){t!==this.curCover&&(this.curCover=t,this.currentElement.classList.add("old"),this.cur=(this.cur+1)%2,this.currentElement.classList.remove("old"),this.currentElement.src=null!==t?t:M)}get currentElement(){return this.elements[this.cur]}}window.addEventListener("DOMContentLoaded",function(){P()})}();
//# sourceMappingURL=app.js.map
